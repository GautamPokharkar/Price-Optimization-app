<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Price Optimization</title>
  <link
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h2 class="mb-4">Price Optimization Dashboard</h2>
    <form id="optimize-form">
      <div class="form-row">
        <div class="form-group col-md-4">
          <label>Product</label>
          <select name="product_id" class="form-control" required>
            <option value="" disabled selected>Select a productâ€¦</option>
            {% for code in stock_codes %}
              <option value="{{ code }}">{{ code }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group col-md-4">
          <label>Unit Price</label>
          <input
            name="unit_price"
            type="number"
            step="0.01"
            class="form-control"
            required />
        </div>
        <div class="form-group col-md-4">
          <label>Competitor Price</label>
          <input
            name="competitor_price"
            type="number"
            step="0.01"
            class="form-control"
            required />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group col-md-4">
          <label>Cost Price</label>
          <input
            name="cost_price"
            type="number"
            step="0.01"
            class="form-control"
            required />
        </div>
        <div class="form-group col-md-4">
          <label>Is Weekend</label>
          <select name="is_weekend" class="form-control" required>
            <option value="" disabled selected>Yes or No</option>
            <option value="1">Yes</option>
            <option value="0">No</option>
          </select>
        </div>
        <div class="form-group col-md-4">
          <label>Total Quantity</label>
          <input
            name="total_quantity"
            type="number"
            step="1"
            class="form-control"
            required />
        </div>
      </div>
      <button class="btn btn-primary">Optimize</button>
    </form>

    <hr />

    <div id="result" class="mt-4" style="display: none;">
      <h4>Results for <span id="chosen-product"></span></h4>
      <p>
        <strong>Optimal Price:</strong> $
        <span id="optimal-price"></span>
      </p>
      <p>
        <strong>Max Profit:</strong> $
        <span id="max-profit"></span>
      </p>
    </div>

    <div class="mt-5">
      <h5>Profit vs. Price</h5>
      <canvas id="profitChart" height="100"></canvas>
    </div>
  </div>

  <script>
    let profitChart;

    document
      .getElementById("optimize-form")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const payload = {
          product_id: fd.get("product_id"),
          unit_price: parseFloat(fd.get("unit_price")),
          competitor_price: parseFloat(fd.get("competitor_price")),
          cost_price: parseFloat(fd.get("cost_price")),
          is_weekend: parseInt(fd.get("is_weekend")),
          total_quantity: parseInt(fd.get("total_quantity")),
        };

        const res = await fetch("/api/optimize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const err = await res.json();
          return alert(err.error || "Optimization failed");
        }
        const data = await res.json();

        document.getElementById("chosen-product").textContent =
          data.product_id;
        document.getElementById("optimal-price").textContent =
          data.optimal_price;
        document.getElementById("max-profit").textContent =
          data.max_profit;
        document.getElementById("result").style.display = "block";

        const ctx = document
          .getElementById("profitChart")
          .getContext("2d");
        if (profitChart) profitChart.destroy();

        profitChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: data.price_profit_curve.prices,
            datasets: [
              {
                label: "Profit",
                data: data.price_profit_curve.profits,
                fill: false,
                borderColor: "rgba(75,192,192,1)",
                tension: 0.1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: { title: { display: true, text: "Price" } },
              y: { title: { display: true, text: "Profit" } },
            },
          },
        });
      });
  </script>
</body>
</html>
